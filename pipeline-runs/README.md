# Overview

A base for scripts and configuration files used to
run a given pipeline.

## Workflow:   gen_config.sh => gen_pcf.sh => build_pipeline.sh

## GOAL
Create an automation that runs pipelines in parallel using Jenkins server.

## What's Done
- ### Created a set of configuration files and shell scripts that can be used to:
* generate the main configuration of a given pipeline project. This main config
  file contains mapping to the input datasets, reference indexes, results directory, path
  to the design file, and more. (gen_config.sh) 
* generate the pcf config file for each sample using the generated main configuration file (gen_pcf.sh)
* use the CLI to submit all sample pipelines to Jenkins server (build_pipeline.sh)

- ### Created Jenkins GUI for:
* gen_config.sh 
* gen_pcf.sh

- ### Tested 
* gen_config.sh (Jenkins step currently running as part of our pipeline process)
* gen_pcf.sh (Jenkins step currently running as part of our pipeline process) 
* build_pipeline.sh (only CLI test)

## To Do

* Setup Jenkins GUI for build_pipeline.sh
* Setup the main workflow on Jenkins (gen_config.sh => gen_pcf.sh => build_pipeline.sh)

## Project Files Organization 

### The Config files directory (cfgs)
Contains the following files:

* ### biocore.cfg : 
  Sets path to local storage of programs, indexes, data,and results
* cutadapt.tool_options.cfg  : sets CUTADAPT_CMD_OPTIONS variable
* fastqc.tool_options.cfg   : sets FASTQC_CMD_OPTIONS variable 
* bowtie2.aligner_options.cfg  : sets ALIGNER_CMD_OPTIONS variable 
* cwl.tool_options.cfg  : sets CWL_COMMAND_OPTIONS variable      
* jenkins.cfg  : sets Jenkins global environment variables     
* trimmomatic.tool_options.cfg: sets trim global environment variables (JAVA_CMD, ILLUMINACLIP_OPTIONS,TRIMM_CMD_OPTIONS)

### Scripts Directory (src)

Contains the following scripts:

#### Tested as standalone script

* Experiment Main Config File Genarator : [gen_config.sh](#gen_config.sh)
* Sample Config File Generator: [gen_pcf.sh](#gen_pcf.sh)
* Jenkins Job Submitter : [build_pipeline.sh](#build_pipeline.sh) 

#### gen_config.sh
Generates the main config file for the experiment pipeline.  Runs on Jenkins using jenkins GUI as input form can also be ran on the CLI - 

Jenkins job: https://jenkins.mdibl.org/view/CWL_Workflows/job/generate-project-config/
```
Output: 
  /path2/team_name/projectname/results/cfgs/pipeline.cfg 

Input: 
1)  The team name associated with this project -  as found under /data/internal 
2)  The project name - as found under /data/internal/team_name/ 
3)  The organism name - according to our standards 
4)  The username for the owner of the pipeline results directory - Must be a valid username 
5)  The reference database source - according to our standards - see /data/external 
6) The reference database version - example 95  for ensembl release 95 
7) The reference dataset - according to our standards under /data/scratch/ 
8) READ1 pattern 
9) READ2 pattern 
10) cwl_script  - full path to the cwl script to use for this pipeline
````
#### gen_pcf.sh

Generates a pcf config file for a given pipeline. Runs on Jenkins using jenkins GUI as input form can also be ran on the CLI.

JENKINS JOB: https://jenkins.mdibl.org/view/CWL_Workflows/job/generate-pipeline-pcf/

```
Usage: ./$script_name path2_pipeline.cfg [sampleID]
Where:
   path2_pipeline.cfg: is the full path to this pipeline config file.
          The pipeline config file is generated by running the program gen_config.sh
   sampleID:  is optional - is the sample Id as found in the experiment design file.
         Default, generates a pcf file for each sample listed in the design file.

   Assumptions: assumes the following structure under the script parent directory
      1) cfgs 
      2) src
   Assumptions: assumes the following config files in the cfgs directory
      1) cwl.tool_options.cfg

   What the program does: generates a pcf file for each sample listed in the design file or
     generates a pcf file for the specified sampleID

```
#### build_pipeline.sh

Triggers  a pipeline build on Jenkins server.

```
 Usage: ./$script_name path2_pipeline.cfg [sampleID]
   Where:
   path2_pipeline.cfg: Required - is the full path to your pipeline project config file.
                       The pipeline config file is generated by running the program gen_config.sh
   sampleID:  Optional - is the sample Id as found in the experiment design file.
              Default, triggers a pipeline run for each sample listed in the design file.

   Example 1: ./$script_name /data/scratch/rna-seq/JarodRollins/JR18-08/results/cfgs/pipeline.cfg
   Example 2: ./$script_name /data/scratch/rna-seq/JarodRollins/JR18-08/results/cfgs/pipeline.cfg 22_TO_01_S9

   Assumptions: assumes the following structure under $script_name script parent directory
      1) cfgs 
      2) src
   Assumptions: assumes the following config files in the cfgs directory
      1) jenkins.cfg

   The program triggers a pipeline build on Jenkins for each sample listed in the design file(Example 1) or
   for the specified sampleID (Example 2)
``` 

### To Be Tested as standalone
* bowtie2.aligner.sh  
* cutadapt.sh  
* trimmomatic.sh
* fastqc.sh
* run-pipeline.sh
* run-cwl.sh   
